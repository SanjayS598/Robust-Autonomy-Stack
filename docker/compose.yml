# Docker Compose configuration for CARLA Robust Autonomy Stack
# Runs CARLA server (headless) + optional Python client container
#
# IMPORTANT: CARLA only supports x86_64 architecture
# - Will NOT work on Apple Silicon (M1/M2/M3/M4) Macs
# - Requires Intel Mac, Linux x86_64, or remote server
# See ARM_MAC_USERS.md for alternatives

services:
  # CARLA simulator server (headless, low-fidelity)
  carla-server:
    image: carlasim/carla:0.9.15
    platform: linux/amd64
    container_name: carla-server
    command: /bin/bash -c "./CarlaUE4.sh -RenderOffScreen -quality-level=Low -nosound -carla-rpc-port=2000"
    ports:
      - "2000:2000"  # RPC port for Python API
      - "2001:2001"  # Streaming port
    environment:
      - DISPLAY=
    # Health check: verify port 2000 is responding
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 1 bash -c '</dev/tcp/localhost/2000'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Resource limits (adjust based on your Mac's resources)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    networks:
      - carla-net
    # Keep container running even if it crashes (for debugging)
    restart: unless-stopped

  # Python client container (optional - for running autonomy stack)
  client:
    build:
      context: ..
      dockerfile: docker/client/Dockerfile
    container_name: carla-client
    depends_on:
      carla-server:
        condition: service_healthy
    volumes:
      # Mount code for development (changes reflect immediately)
      - ../carla_robust_autonomy_stack:/app/carla_robust_autonomy_stack
      - ../scenarios:/app/scenarios
      - ../runs:/app/runs
    environment:
      - CARLA_HOST=carla-server
      - CARLA_PORT=2000
    networks:
      - carla-net
    # Don't start automatically - use 'docker compose run client <command>'
    profiles:
      - client

networks:
  carla-net:
    driver: bridge
